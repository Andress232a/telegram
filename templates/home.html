<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram - Gestor</title>
    <!-- Video.js CSS -->
    <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0e1621;
            color: #e4e6eb;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }
        
        .sidebar {
            width: 320px;
            background: #17212b;
            border-right: 1px solid #242f3d;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 15px 20px;
            background: #17212b;
            border-bottom: 1px solid #242f3d;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #e4e6eb;
            flex: 1;
        }
        
        .logout-btn {
            background: transparent;
            border: none;
            color: #8e9297;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: #242f3d;
            color: #e4e6eb;
        }
        
        .search-box {
            padding: 10px 15px;
            background: #242f3d;
            border: none;
            border-radius: 20px;
            color: #e4e6eb;
            font-size: 14px;
            width: 100%;
            margin: 10px 15px;
        }
        
        .search-box:focus {
            outline: none;
            background: #2b3542;
        }
        
        .folder-tabs {
            display: flex;
            padding: 10px;
            gap: 5px;
            border-bottom: 1px solid #242f3d;
            background: #17212b;
            overflow-x: auto;
            flex-shrink: 0;
        }
        
        .folder-tab {
            padding: 8px 16px;
            background: #242f3d;
            border: none;
            border-radius: 20px;
            color: #8e9297;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .folder-tab:hover {
            background: #2b3542;
            color: #e4e6eb;
        }
        
        .folder-tab.active {
            background: #2b5278;
            color: #e4e6eb;
        }
        
        .folder-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 5px 0;
        }
        
        .chat-type-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            margin-left: 5px;
        }
        
        .chat-type-badge.user {
            background: rgba(67, 160, 71, 0.3);
            color: #4caf50;
        }
        
        .chat-type-badge.group {
            background: rgba(33, 150, 243, 0.3);
            color: #2196f3;
        }
        
        .chat-type-badge.channel {
            background: rgba(156, 39, 176, 0.3);
            color: #9c27b0;
        }
        
        .chat-type-badge.supergroup {
            background: rgba(255, 152, 0, 0.3);
            color: #ff9800;
        }
        
        .chat-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #242f3d;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-item:hover {
            background: #242f3d;
        }
        
        .chat-item.active {
            background: #2b5278;
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }
        
        .chat-info {
            flex: 1;
            min-width: 0;
        }
        
        .chat-name {
            font-weight: 600;
            font-size: 15px;
            color: #e4e6eb;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-preview {
            font-size: 13px;
            color: #8e9297;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            font-size: 12px;
            color: #8e9297;
            margin-left: auto;
        }
        
        .unread-badge {
            background: #2b5278;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            margin-left: auto;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0e1621;
        }
        
        .chat-header {
            padding: 15px 20px;
            background: #17212b;
            border-bottom: 1px solid #242f3d;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: white;
        }
        
        .chat-header-info h2 {
            font-size: 16px;
            font-weight: 600;
            color: #e4e6eb;
        }
        
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 12px;
            background: #242f3d;
            color: #e4e6eb;
            word-wrap: break-word;
            align-self: flex-start;
        }
        
        .message.own {
            background: #2b5278;
            align-self: flex-end;
        }
        
        .message-video-thumbnail {
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .message-video {
            position: relative;
        }
        
        .message-video video,
        .message-video .video-js {
            width: 100%;
            max-width: 400px;
            display: block;
            cursor: pointer;
        }
        
        .message-video .video-js {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .context-menu {
            position: fixed;
            background: #242f3d;
            border: 1px solid #2b3542;
            border-radius: 8px;
            padding: 5px 0;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            color: #e4e6eb;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .context-menu-item:hover {
            background: #2b3542;
        }
        
        .upload-video-btn {
            position: fixed;
            bottom: 80px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 100;
        }
        
        .upload-video-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .message-time {
            font-size: 11px;
            color: #8e9297;
            margin-top: 5px;
            text-align: right;
        }
        
        .input-area {
            padding: 15px 20px;
            background: #17212b;
            border-top: 1px solid #242f3d;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .upload-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2b5278;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .upload-btn:hover {
            background: #3a6a9a;
        }
        
        .message-input {
            flex: 1;
            padding: 10px 15px;
            background: #242f3d;
            border: none;
            border-radius: 20px;
            color: #e4e6eb;
            font-size: 14px;
        }
        
        .message-input:focus {
            outline: none;
            background: #2b3542;
        }
        
        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2b5278;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .send-btn:hover {
            background: #3a6a9a;
        }
        
        .empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #8e9297;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #8e9297;
        }
        
        .upload-progress-container {
            position: fixed;
            bottom: 150px;
            right: 30px;
            background: #17212b;
            border: 1px solid #242f3d;
            border-radius: 12px;
            padding: 20px;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }
        
        .upload-progress-container.show {
            display: block;
        }
        
        /* Modal para subir video con descripci√≥n */
        .video-upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .video-upload-modal-content {
            background: #17212b;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        .video-upload-modal-header {
            padding: 20px;
            border-bottom: 1px solid #242f3d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .video-upload-modal-header h3 {
            margin: 0;
            color: #e4e6eb;
            font-size: 18px;
        }
        
        .video-upload-modal-close {
            background: none;
            border: none;
            color: #e4e6eb;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .video-upload-modal-close:hover {
            background: #242f3d;
        }
        
        .video-upload-modal-body {
            padding: 20px;
        }
        
        .video-upload-info {
            margin-bottom: 15px;
            padding: 10px;
            background: #242f3d;
            border-radius: 8px;
            color: #e4e6eb;
            font-size: 14px;
        }
        
        .video-upload-modal-body label {
            display: block;
            margin-bottom: 8px;
            color: #e4e6eb;
            font-size: 14px;
            font-weight: 500;
        }
        
        .video-description-input {
            width: 100%;
            padding: 12px;
            background: #242f3d;
            border: 1px solid #2b3542;
            border-radius: 8px;
            color: #e4e6eb;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            box-sizing: border-box;
        }
        
        .video-description-input:focus {
            outline: none;
            border-color: #2b5278;
            background: #2b3542;
        }
        
        .video-upload-modal-footer {
            padding: 20px;
            border-top: 1px solid #242f3d;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .video-upload-cancel-btn,
        .video-upload-submit-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .video-upload-cancel-btn {
            background: #242f3d;
            color: #e4e6eb;
        }
        
        .video-upload-cancel-btn:hover {
            background: #2b3542;
        }
        
        .video-upload-submit-btn {
            background: #2b5278;
            color: #e4e6eb;
        }
        
        .video-upload-submit-btn:hover {
            background: #3a6a9a;
        }
        
        .video-upload-submit-btn:disabled {
            background: #242f3d;
            color: #6b7280;
            cursor: not-allowed;
        }
        
        .upload-progress-title {
            color: #e4e6eb;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .upload-progress-bar {
            width: 100%;
            height: 8px;
            background: #242f3d;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
        
        .upload-progress-text {
            color: #8e9297;
            font-size: 12px;
            text-align: center;
        }
        
        .upload-progress-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: #8e9297;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }
        
        .upload-progress-close:hover {
            color: #e4e6eb;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="chat-avatar">TG</div>
            <h1>Telegram</h1>
            <button class="logout-btn" onclick="logout()" title="Cerrar sesi√≥n">üö™</button>
        </div>
        <input type="text" class="search-box" placeholder="Buscar..." id="searchBox" oninput="filterChats()">
        <div class="folder-tabs" id="folderTabs">
            <button class="folder-tab active" onclick="switchFolder('all')">
                <span>üí¨</span> Todos
            </button>
            <button class="folder-tab" onclick="switchFolder('users')">
                <span>üë§</span> Personas
            </button>
            <button class="folder-tab" onclick="switchFolder('groups')">
                <span>üë•</span> Grupos
            </button>
            <button class="folder-tab" onclick="switchFolder('channels')">
                <span>üì¢</span> Canales
            </button>
            <button class="folder-tab" onclick="switchFolder('pinned')">
                <span>üìå</span> Fijados
            </button>
        </div>
        <div class="chats-list" id="chatsList">
            <div class="loading">Cargando chats...</div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="chat-header" id="chatHeader" style="display: none;">
            <div class="chat-header-avatar" id="chatHeaderAvatar">?</div>
            <div class="chat-header-info">
                <h2 id="chatHeaderName">Selecciona un chat</h2>
            </div>
        </div>
        
        <div class="messages-area" id="messagesArea">
            <div class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <p>Selecciona un chat para comenzar</p>
                <p style="font-size: 0.85em; color: #888; margin-top: 10px;">
                    üí° <strong>Nota:</strong> Los videos se suben desde la app de Telegram.<br>
                    Esta aplicaci√≥n web solo muestra y reproduce los videos que ya est√°n en Telegram.
                </p>
            </div>
        </div>
        
        <div class="input-area" id="inputArea" style="display: none;">
            <!-- Subida de videos deshabilitada - Los videos se suben desde la app de Telegram -->
            <input type="file" id="videoInput" accept="video/*" style="display: none;">
            <!-- <button class="upload-btn" onclick="document.getElementById('videoInput').click()">üìé</button> -->
            <input type="text" class="message-input" id="messageInput" placeholder="Escribe un mensaje...">
            <button class="send-btn" id="sendBtn">‚û§</button>
        </div>
        
        <!-- Bot√≥n de subida deshabilitado - Los videos se suben desde la app de Telegram -->
        <button class="upload-video-btn" id="uploadVideoBtn" title="Subir video desde la app de Telegram" style="display: none;">üìπ</button>
        
        <!-- Modal para agregar descripci√≥n al video -->
        <div class="video-upload-modal" id="videoUploadModal" style="display: none;">
            <div class="video-upload-modal-content">
                <div class="video-upload-modal-header">
                    <h3>Subir video</h3>
                    <button class="video-upload-modal-close" onclick="closeVideoUploadModal()">‚úï</button>
                </div>
                <div class="video-upload-modal-body">
                    <div class="video-upload-info" id="videoUploadInfo"></div>
                    <label for="videoDescription">Descripci√≥n (opcional):</label>
                    <textarea 
                        id="videoDescription" 
                        class="video-description-input" 
                        placeholder="Escribe una descripci√≥n para el video..."
                        rows="4"
                    ></textarea>
                </div>
                <div class="video-upload-modal-footer">
                    <button class="video-upload-cancel-btn" onclick="closeVideoUploadModal()">Cancelar</button>
                    <button class="video-upload-submit-btn" id="videoUploadSubmitBtn" onclick="confirmVideoUpload()">Subir video</button>
                </div>
            </div>
        </div>
        
        <div class="upload-progress-container" id="uploadProgress">
            <button class="upload-progress-close" onclick="closeUploadProgress()">‚úï</button>
            <div class="upload-progress-title" id="uploadProgressTitle">Subiendo video...</div>
            <div class="upload-progress-bar">
                <div class="upload-progress-fill" id="uploadProgressFill"></div>
            </div>
            <div class="upload-progress-text" id="uploadProgressText">0%</div>
        </div>
        
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" onclick="copyVideoLink()">üìã Copiar link</div>
            <div class="context-menu-item" onclick="downloadVideo()">üíæ Descargar</div>
            <div class="context-menu-item" onclick="closeContextMenu()">‚úï Cerrar</div>
        </div>
    </div>
    
    <script>
        let currentChatId = null;
        let chats = [];
        let chatFolders = [];  // Carpetas personalizadas de Telegram
        let currentFolder = 'all';  // 'all' o folder.id
        
        // Cargar chats al iniciar
        async function loadChats() {
            try {
                const response = await fetch('/api/chats');
                const data = await response.json();
                
                console.log('Respuesta de chats:', data);
                
                if (data.error) {
                    document.getElementById('chatsList').innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                if (data.chats && Array.isArray(data.chats)) {
                    chats = data.chats;
                    chatFolders = data.folders || [];  // Carpetas personalizadas
                    
                    console.log(`‚úÖ ${chats.length} chats cargados`);
                    console.log(`‚úÖ ${chatFolders.length} carpetas personalizadas`);
                    console.log('üìä Estad√≠sticas:', data.stats);
                    
                    // Renderizar pesta√±as de carpetas
                    renderFolderTabs();
                    
                    // Renderizar chats
                    renderChats();
                } else {
                    console.error('Formato de datos inv√°lido:', data);
                    document.getElementById('chatsList').innerHTML = '<div class="loading">Error: Formato de datos inv√°lido</div>';
                }
            } catch (error) {
                console.error('Error cargando chats:', error);
                document.getElementById('chatsList').innerHTML = `<div class="loading">Error al cargar chats: ${error.message}</div>`;
            }
        }
        
        function renderFolderTabs() {
            const container = document.getElementById('folderTabs');
            if (!container) return;
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            // Agregar pesta√±a "Todos"
            const allTab = document.createElement('button');
            allTab.className = 'folder-tab' + (currentFolder === 'all' ? ' active' : '');
            allTab.onclick = () => switchFolder('all');
            allTab.innerHTML = `<span>üí¨</span> Todos <span class="folder-badge">${chats.length}</span>`;
            container.appendChild(allTab);
            
            // Agregar carpetas personalizadas
            chatFolders.forEach(folder => {
                const folderTab = document.createElement('button');
                folderTab.className = 'folder-tab' + (currentFolder === folder.id ? ' active' : '');
                folderTab.onclick = () => switchFolder(folder.id);
                
                const icon = folder.icon_emoji ? folder.icon_emoji : 'üìÅ';
                const unreadBadge = folder.unread_count > 0 ? `<span class="unread-badge">${folder.unread_count}</span>` : '';
                
                folderTab.innerHTML = `<span>${icon}</span> ${folder.title} <span class="folder-badge">${folder.chat_count}</span>${unreadBadge}`;
                container.appendChild(folderTab);
            });
        }
        
        function switchFolder(folderId) {
            currentFolder = folderId;
            
            // Actualizar pesta√±as activas
            document.querySelectorAll('.folder-tab').forEach(tab => {
                tab.classList.remove('active');
                // Verificar si esta pesta√±a corresponde a la carpeta seleccionada
                const tabText = tab.textContent.trim();
                if (folderId === 'all' && tabText.includes('Todos')) {
                    tab.classList.add('active');
                } else if (folderId !== 'all') {
                    // Para carpetas personalizadas, verificar el onclick
                    const onclickStr = tab.onclick ? tab.onclick.toString() : '';
                    if (onclickStr.includes(`'${folderId}'`) || onclickStr.includes(`"${folderId}"`)) {
                        tab.classList.add('active');
                    }
                }
            });
            
            // Limpiar b√∫squeda
            document.getElementById('searchBox').value = '';
            
            // Renderizar chats de la carpeta seleccionada
            renderChats();
        }
        
        function filterChats() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            renderChats(searchTerm);
        }
        
        function renderChats(searchTerm = '') {
            const container = document.getElementById('chatsList');
            if (!container) {
                console.error('No se encontr√≥ el contenedor de chats');
                return;
            }
            
            // Obtener chats de la carpeta actual
            let chatsToShow = [];
            
            if (currentFolder === 'all') {
                chatsToShow = chats;
            } else {
                // Buscar la carpeta seleccionada
                const selectedFolder = chatFolders.find(f => f.id === currentFolder);
                if (selectedFolder) {
                    chatsToShow = selectedFolder.chats || [];
                } else {
                    chatsToShow = chats;
                }
            }
            
            // Aplicar filtro de b√∫squeda si existe
            if (searchTerm) {
                chatsToShow = chatsToShow.filter(chat => 
                    chat.name.toLowerCase().includes(searchTerm)
                );
            }
            
            if (!chatsToShow || chatsToShow.length === 0) {
                container.innerHTML = `<div class="loading">No hay chats en esta carpeta${searchTerm ? ' que coincidan con la b√∫squeda' : ''}</div>`;
                return;
            }
            
            try {
                // Limpiar contenedor
                container.innerHTML = '';
                
                // Crear elementos de chat uno por uno
                chatsToShow.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.setAttribute('data-chat-id', chat.id);
                    chatItem.onclick = () => selectChat(chat.id, chat.name);
                    
                    const initial = chat.name ? chat.name.charAt(0).toUpperCase() : '?';
                    const lastMsg = chat.last_message ? (chat.last_message.text || 'Sin mensajes') : 'Sin mensajes';
                    const time = chat.last_message && chat.last_message.date 
                        ? new Date(chat.last_message.date * 1000).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})
                        : '';
                    
                    // Limitar longitud del mensaje
                    const previewMsg = lastMsg.length > 50 ? lastMsg.substring(0, 50) + '...' : lastMsg;
                    
                    // Icono seg√∫n tipo de chat
                    let typeIcon = 'üí¨';
                    let typeClass = '';
                    if (chat.type === 'user') typeIcon = 'üë§';
                    else if (chat.type === 'group') typeIcon = 'üë•';
                    else if (chat.type === 'supergroup') typeIcon = 'üë•';
                    else if (chat.type === 'channel') typeIcon = 'üì¢';
                    
                    // Badge de tipo
                    const typeBadge = chat.type ? `<span class="chat-type-badge ${chat.type}">${chat.type}</span>` : '';
                    
                    chatItem.innerHTML = `
                        <div class="chat-avatar">${typeIcon}</div>
                        <div class="chat-info">
                            <div class="chat-name">
                                ${chat.name || 'Sin nombre'}
                                ${typeBadge}
                                ${chat.is_verified ? '‚úì' : ''}
                                ${chat.is_premium ? '‚≠ê' : ''}
                            </div>
                            <div class="chat-preview">${previewMsg}</div>
                        </div>
                        ${time ? `<div class="chat-time">${time}</div>` : ''}
                        ${chat.unread_count > 0 ? `<div class="unread-badge">${chat.unread_count}</div>` : ''}
                    `;
                    
                    container.appendChild(chatItem);
                });
                
                console.log(`‚úÖ ${chatsToShow.length} chats renderizados de la carpeta "${currentFolder}"`);
            } catch (error) {
                console.error('Error renderizando chats:', error);
                container.innerHTML = '<div class="loading">Error al mostrar chats</div>';
            }
        }
        
        async function selectChat(chatId, chatName) {
            console.log('üì± Seleccionando chat:', chatId, chatName);
            currentChatId = chatId;
            
            // Actualizar UI
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            // Encontrar el elemento del chat seleccionado y marcarlo como activo
            const selectedChatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            if (selectedChatItem) {
                selectedChatItem.classList.add('active');
            }
            
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('chatHeaderName').textContent = chatName;
            document.getElementById('chatHeaderAvatar').textContent = chatName.charAt(0).toUpperCase();
            document.getElementById('inputArea').style.display = 'flex';
            // Bot√≥n de subida deshabilitado - Los videos se suben desde la app de Telegram
            // document.getElementById('uploadVideoBtn').style.display = 'block';
            document.getElementById('messagesArea').innerHTML = '<div class="loading">Cargando mensajes...</div>';
            
            // Cargar mensajes
            await loadMessages(chatId);
        }
        
        async function loadMessages(chatId) {
            console.log('üîÑ Cargando mensajes para chat:', chatId);
            try {
                const response = await fetch(`/api/chat/${chatId}/messages?limit=50`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Respuesta de mensajes:', data);
                
                if (data.error) {
                    console.error('‚ùå Error en respuesta:', data.error);
                    document.getElementById('messagesArea').innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                if (data.messages && Array.isArray(data.messages)) {
                    console.log(`‚úÖ ${data.messages.length} mensajes recibidos`);
                    renderMessages(data.messages);
                } else {
                    console.error('‚ùå Formato de datos inv√°lido:', data);
                    document.getElementById('messagesArea').innerHTML = '<div class="loading">Error: Formato de datos inv√°lido</div>';
                }
            } catch (error) {
                console.error('‚ùå Error cargando mensajes:', error);
                document.getElementById('messagesArea').innerHTML = `<div class="loading">Error al cargar mensajes: ${error.message}</div>`;
            }
        }
        
        let currentVideoUrl = null;
        
        // Funci√≥n para cargar el video cuando el usuario hace click en la miniatura
        function loadVideoOnClick(videoId, videoUrl, videoIdFromUrl) {
            console.log('‚ñ∂Ô∏è Cargando video:', videoId, 'videoUrl:', videoUrl, 'videoIdFromUrl:', videoIdFromUrl);
            
            const videoEl = document.getElementById(videoId);
            const thumbnailEl = document.getElementById(videoId + '-thumbnail');
            
            if (!videoEl) {
                console.error('‚ùå No se encontr√≥ el elemento de video:', videoId);
                return;
            }
            
            // Verificar que el video correcto est√© asociado
            const expectedVideoId = videoEl.getAttribute('data-video-id');
            if (expectedVideoId && expectedVideoId !== videoIdFromUrl) {
                console.warn('‚ö†Ô∏è Advertencia: El video ID no coincide. Esperado:', expectedVideoId, 'Recibido:', videoIdFromUrl);
            }
            
            // Ocultar miniatura y mostrar video
            if (thumbnailEl) {
                thumbnailEl.style.display = 'none';
            }
            videoEl.style.display = 'block';
            
            // Cargar el video solo ahora
            if (videoEl.readyState === 0) { // Si no se ha cargado nada
                const source = videoEl.querySelector('source');
                if (source) {
                    // Asegurarse de que la URL sea correcta
                    const currentSrc = source.src;
                    const expectedSrc = videoUrl.split('?')[0]; // Sin par√°metros de cach√©
                    
                    if (!currentSrc.includes(expectedSrc)) {
                        console.log('üîÑ Actualizando source del video:', expectedSrc);
                        source.src = videoUrl + (videoUrl.includes('?') ? '&' : '?') + '_t=' + Date.now();
                    } else if (!currentSrc.includes('_t=')) {
                        // Agregar timestamp si no lo tiene
                        source.src = currentSrc + (currentSrc.includes('?') ? '&' : '?') + '_t=' + Date.now();
                    }
                }
                
                console.log('üì• Cargando video desde:', source ? source.src : 'N/A');
                videoEl.load();
            } else {
                console.log('‚úÖ Video ya est√° cargado (readyState:', videoEl.readyState, ')');
            }
            
            // Manejar errores del video
            videoEl.addEventListener('error', function(e) {
                console.error('‚ùå Error en el video:', e);
                const error = videoEl.error;
                if (error) {
                    let errorMsg = 'Error desconocido';
                    switch (error.code) {
                        case error.MEDIA_ERR_ABORTED:
                            errorMsg = 'La carga del video fue cancelada';
                            break;
                        case error.MEDIA_ERR_NETWORK:
                            errorMsg = 'Error de red al cargar el video';
                            break;
                        case error.MEDIA_ERR_DECODE:
                            errorMsg = 'Error al decodificar el video';
                            break;
                        case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            errorMsg = 'El formato del video no es compatible';
                            break;
                    }
                    console.error(`‚ùå Error del video (c√≥digo ${error.code}): ${errorMsg}`);
                    
                    // Mostrar mensaje de error al usuario
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,0,0,0.8); color: white; padding: 10px; border-radius: 5px; text-align: center; z-index: 10;';
                    errorDiv.textContent = `Error: ${errorMsg}`;
                    videoEl.parentElement.style.position = 'relative';
                    videoEl.parentElement.appendChild(errorDiv);
                    
                    // Intentar recargar despu√©s de 3 segundos
                    setTimeout(() => {
                        errorDiv.remove();
                        console.log('üîÑ Reintentando cargar video...');
                        videoEl.load();
                    }, 3000);
                }
            });
            
            // Intentar reproducir
            videoEl.play().catch(e => {
                console.log('Autoplay bloqueado:', e);
            });
        }
        
        function renderMessages(messages) {
            const container = document.getElementById('messagesArea');
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>No hay mensajes</p></div>';
                return;
            }
            
            // üöÄ FIX: Renderizar mensajes y luego forzar carga de miniaturas
            const messagesHtml = messages.reverse().map(msg => {
                const time = msg.date ? new Date(msg.date * 1000).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '';
                const isOwn = msg.from_id === null || msg.from_id === 'None';
                
                let content = '';
                // Si tiene video, mostrar miniatura primero (como Telegram Web)
                if (msg.video_url) {
                    // Usar video_id directamente del mensaje (m√°s confiable)
                    const videoIdFromMsg = msg.video_id || msg.video_url.split('/').pop().split('?')[0];
                    
                    // URL para compartir (watch_url si existe, sino construir desde video_url)
                    const watchUrl = msg.watch_url || msg.video_url.replace('/api/video/', '/watch/');
                    const fullUrl = window.location.origin + watchUrl;
                    
                    // Usar msg.id como base para el ID √∫nico del elemento DOM (m√°s confiable que Date.now())
                    const uniqueId = msg.id || `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    const videoElementId = `video-${uniqueId}`;
                    
                    // Usar video_id del mensaje directamente (no extraer de URL)
                    const videoIdForThumbnail = videoIdFromMsg;
                    
                    // Agregar timestamp √∫nico para evitar cach√© (usar msg.id para que sea √∫nico por mensaje)
                    const thumbnailUrl = `/api/video/${videoIdForThumbnail}/thumbnail?_t=${msg.id || Date.now()}`;
                    
                    console.log('üé¨ Renderizando video:', {
                        'msg.id': msg.id,
                        'video_id': videoIdForThumbnail,
                        'video_url': msg.video_url,
                        'watch_url': watchUrl,
                        'videoElementId': videoElementId,
                        'thumbnailUrl': thumbnailUrl
                    });
                    
                    // Mostrar miniatura primero, video solo cuando se hace click (como Telegram Web)
                    content = `
                        <div class="message-video-container" 
                             oncontextmenu="event.preventDefault(); showContextMenu(event, '${fullUrl}')"
                             style="
                                 position: relative;
                                 width: 100%;
                                 max-width: 400px;
                                 border-radius: 12px;
                                 overflow: hidden;
                                 background: #000;
                                 margin: 8px 0;
                                 cursor: pointer;
                             "
                             onclick="loadVideoOnClick('${videoElementId}', '${msg.video_url}', '${videoIdForThumbnail}')"
                        >
                            <img id="${videoElementId}-thumbnail" 
                                 src="${thumbnailUrl}" 
                                 loading="eager"
                                 decoding="async"
                                 style="
                                     width: 100%;
                                     height: auto;
                                     display: block;
                                     max-height: 500px;
                                     object-fit: cover;
                                     min-height: 200px;
                                     background: #1a1a1a;
                                 "
                                 onerror="
                                     console.error('‚ùå Error cargando miniatura para video ${videoIdForThumbnail}');
                                     // Intentar cargar de nuevo con timestamp diferente
                                     const img = this;
                                     setTimeout(() => {
                                         const retryUrl = '/api/video/${videoIdForThumbnail}/thumbnail?_t=' + Date.now();
                                         img.src = retryUrl;
                                     }, 500);
                                 "
                                 onload="console.log('‚úÖ Miniatura cargada para video ${videoIdForThumbnail}');"
                                 alt="Video thumbnail">
                            <video
                                id="${videoElementId}"
                                data-video-id="${videoIdForThumbnail}"
                                controls
                                playsinline
                                preload="none"
                                style="
                                    width: 100%;
                                    height: auto;
                                    display: none;
                                    max-height: 500px;
                                    background: #000;
                                "
                            >
                                <source src="${msg.video_url}" type="video/mp4">
                                Tu navegador no soporta video HTML5.
                            </video>
                            <div style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                width: 64px;
                                height: 64px;
                                background: rgba(0, 0, 0, 0.6);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                pointer-events: none;
                            ">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </div>
                        </div>
                    `;
                    // El video se carga solo cuando el usuario hace click (loadVideoOnClick)
                    // Si tambi√©n tiene texto (caption), mostrarlo debajo del video
                    if (msg.text && msg.text.trim()) {
                        content += `<div class="message-caption" style="margin-top: 8px; font-size: 0.9em; opacity: 0.85; line-height: 1.4;">${msg.text}</div>`;
                    }
                } else if (msg.text) {
                    // Si no tiene video, mostrar solo el texto
                    console.log('üìù Renderizando solo texto:', msg.text);
                    content = `<div>${msg.text}</div>`;
                }
                
                // Debug: mostrar informaci√≥n del mensaje
                if (msg.media && msg.media.type === 'video' && !msg.video_url) {
                    console.warn('‚ö†Ô∏è Mensaje tiene media tipo video pero no tiene video_url:', msg);
                }
                
                return `
                    <div class="message ${isOwn ? 'own' : ''}">
                        ${content}
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }).join('');
            
            // üöÄ FIX: Asignar HTML al contenedor y luego forzar carga de miniaturas
            container.innerHTML = messagesHtml;
            
            // Forzar carga de todas las miniaturas inmediatamente despu√©s de renderizar
            // Esto resuelve el problema de videos que no aparecen inicialmente
            setTimeout(() => {
                const thumbnails = container.querySelectorAll('img[id$="-thumbnail"]');
                console.log(`üñºÔ∏è Forzando carga de ${thumbnails.length} miniaturas...`);
                thumbnails.forEach((img, index) => {
                    // Forzar carga inmediata de la miniatura
                    if (img.src && (!img.complete || img.naturalHeight === 0)) {
                        // Usar requestAnimationFrame para asegurar que el DOM est√° listo
                        requestAnimationFrame(() => {
                            // Si la imagen no se ha cargado, forzar recarga
                            const originalSrc = img.src.split('?')[0]; // Sin par√°metros
                            const newSrc = originalSrc + '?_t=' + (Date.now() + index); // Timestamp √∫nico por imagen
                            img.src = newSrc;
                            img.loading = 'eager'; // Forzar carga eager
                            console.log(`üì• Forzando carga de miniatura ${index + 1}/${thumbnails.length}`);
                        });
                    }
                });
            }, 50); // Reducido a 50ms para carga m√°s r√°pida
            
            // Scroll al final
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        function showContextMenu(event, videoUrl) {
            currentVideoUrl = videoUrl;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
        }
        
        function closeContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            currentVideoUrl = null;
        }
        
        function copyVideoLink() {
            if (!currentVideoUrl) {
                alert('No hay link de video disponible');
                return;
            }
            
            // M√©todo moderno con Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentVideoUrl).then(() => {
                    alert('‚úÖ Link copiado al portapapeles:\n' + currentVideoUrl);
                    closeContextMenu();
                }).catch(err => {
                    console.error('Error al copiar con clipboard API:', err);
                    // Intentar m√©todo fallback
                    copyVideoLinkFallback();
                });
            } else {
                // Usar m√©todo fallback directamente
                copyVideoLinkFallback();
            }
        }
        
        function copyVideoLinkFallback() {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = currentVideoUrl;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                textarea.style.left = '-999999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (successful) {
                    alert('‚úÖ Link copiado al portapapeles:\n' + currentVideoUrl);
                } else {
                    // √öltimo recurso: mostrar el link para copiar manualmente
                    prompt('Copia este link (Ctrl+C):', currentVideoUrl);
                }
                closeContextMenu();
            } catch (err) {
                console.error('Error al copiar con m√©todo fallback:', err);
                // √öltimo recurso: mostrar el link para copiar manualmente
                prompt('Copia este link (Ctrl+C):', currentVideoUrl);
                closeContextMenu();
            }
        }
        
        function downloadVideo() {
            if (currentVideoUrl) {
                window.open(currentVideoUrl, '_blank');
                closeContextMenu();
            }
        }
        
        // Cerrar men√∫ al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu') && !e.target.closest('.message-video')) {
                closeContextMenu();
            }
        });
        
        let currentUploadId = null;
        let progressInterval = null;
        
        // Funci√≥n para mostrar progreso
        function showUploadProgress() {
            const progressContainer = document.getElementById('uploadProgress');
            progressContainer.classList.add('show');
        }
        
        function closeUploadProgress() {
            const progressContainer = document.getElementById('uploadProgress');
            progressContainer.classList.remove('show');
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            currentUploadId = null;
        }
        
        function updateUploadProgress(progress, status) {
            const fill = document.getElementById('uploadProgressFill');
            const text = document.getElementById('uploadProgressText');
            const title = document.getElementById('uploadProgressTitle');
            
            if (!fill || !text || !title) {
                console.warn('Elementos de progreso no encontrados');
                return;
            }
            
            fill.style.width = progress + '%';
            text.textContent = progress + '%';
            
            if (status === 'completed') {
                title.textContent = '‚úÖ Video subido exitosamente';
                // Recargar mensajes inmediatamente cuando se complete
                if (currentChatId) {
                    console.log('üîÑ Recargando mensajes despu√©s de subir video...');
                    setTimeout(async () => {
                        await loadMessages(currentChatId);
                        closeUploadProgress();
                    }, 1000);
                } else {
                    setTimeout(() => {
                        closeUploadProgress();
                    }, 2000);
                }
            } else if (status === 'saving') {
                title.textContent = 'üíæ Guardando archivo en servidor...';
                text.textContent = 'Esperando...';
            } else if (status === 'error') {
                title.textContent = '‚ùå Error al subir video';
                setTimeout(() => {
                    closeUploadProgress();
                }, 5000);
            }
        }
        
        // Funci√≥n para monitorear el progreso
        async function monitorUploadProgress(uploadId) {
            if (!uploadId) {
                console.warn('No se proporcion√≥ upload_id para monitorear');
                return;
            }
            
            // Limpiar cualquier intervalo anterior
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            currentUploadId = uploadId;
            showUploadProgress();
            
            // Iniciar inmediatamente con 0%
            updateUploadProgress(0, 'uploading');
            
            // Consultar progreso muy frecuentemente para actualizaci√≥n en tiempo real
            progressInterval = setInterval(async () => {
                try {
                    // Agregar timestamp para evitar cache del navegador
                    const response = await fetch(`/api/upload/progress/${uploadId}?t=${Date.now()}`, {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const progress = data.progress || 0;
                        const status = data.status || 'uploading';
                        const message = data.message || '';
                        const error = data.error || '';
                        
                        // Actualizar progreso
                        updateUploadProgress(progress, status);
                        
                        // Mostrar mensajes de estado
                        if (message) {
                            console.log(`‚ÑπÔ∏è ${message}`);
                        }
                        
                        // Mostrar errores si existen
                        if (error) {
                            console.error(`‚ùå Error: ${error}`);
                            if (data.error_details) {
                                console.error(`‚ùå Detalles: ${data.error_details}`);
                            }
                        }
                        
                        // Loggear solo cada 10% para no saturar la consola
                        if (progress % 10 === 0 || progress === 100) {
                            console.log(`üìä Progreso: ${progress}%`);
                        }
                        
                        if (status === 'completed') {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            
                            // Recargar mensajes cuando se complete
                            if (currentChatId) {
                                console.log('‚úÖ Subida completada, recargando mensajes...');
                                setTimeout(async () => {
                                    await loadMessages(currentChatId);
                                }, 1500);
                            }
                        } else if (status === 'error') {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            console.error('‚ùå Subida fall√≥:', error);
                        }
                    } else if (response.status === 404) {
                        // Si no se encuentra, puede ser que a√∫n no se haya iniciado
                        // No hacer nada, seguir intentando
                    } else {
                        console.warn('Error obteniendo progreso:', response.status);
                    }
                } catch (error) {
                    console.error('Error obteniendo progreso:', error);
                }
            }, 100); // Verificar cada 100ms para actualizaci√≥n muy fluida
        }
        
        // Variable para almacenar el archivo seleccionado
        let selectedVideoFile = null;
        
        // Funci√≥n para obtener el chat actualmente seleccionado
        function getCurrentChatId() {
            console.log('üîç getCurrentChatId: currentChatId variable =', currentChatId);
            
            // Primero intentar desde la variable
            if (currentChatId) {
                console.log('‚úÖ Usando currentChatId de variable:', currentChatId);
                return currentChatId;
            }
            
            // Si no est√° en la variable, intentar desde el DOM - buscar elemento activo
            const activeChatItem = document.querySelector('.chat-item.active');
            console.log('üîç Buscando elemento activo:', activeChatItem);
            
            if (activeChatItem) {
                const chatIdFromDOM = activeChatItem.getAttribute('data-chat-id');
                console.log('üîç data-chat-id del elemento activo:', chatIdFromDOM);
                
                if (chatIdFromDOM) {
                    console.log('‚úÖ Chat encontrado en DOM (elemento activo), actualizando currentChatId:', chatIdFromDOM);
                    currentChatId = chatIdFromDOM;
                    return chatIdFromDOM;
                } else {
                    console.warn('‚ö†Ô∏è Elemento activo encontrado pero sin data-chat-id');
                }
            }
            
            // Verificar si el header est√° visible (indica que hay un chat seleccionado)
            const chatHeader = document.getElementById('chatHeader');
            const isHeaderVisible = chatHeader && chatHeader.style.display !== 'none';
            console.log('üîç Header visible:', isHeaderVisible);
            
            if (isHeaderVisible) {
                const headerName = document.getElementById('chatHeaderName');
                const headerText = headerName ? headerName.textContent.trim() : '';
                console.log('üîç Nombre en header:', headerText);
                
                if (headerText) {
                    // Buscar el chat por nombre en todos los elementos
                    const allChatItems = document.querySelectorAll('.chat-item[data-chat-id]');
                    console.log('üîç Total de chats encontrados:', allChatItems.length);
                    
                    for (let item of allChatItems) {
                        const chatNameElement = item.querySelector('.chat-name');
                        if (chatNameElement) {
                            // Obtener solo el texto, sin los badges ni otros elementos
                            const chatName = chatNameElement.textContent.trim();
                            // Limpiar el nombre de posibles badges o verificaciones
                            const cleanChatName = chatName.replace(/‚úì/g, '').replace(/\s+/g, ' ').trim();
                            const cleanHeaderName = headerText.replace(/‚úì/g, '').replace(/\s+/g, ' ').trim();
                            
                            console.log('üîç Comparando:', cleanChatName, 'con', cleanHeaderName);
                            
                            if (cleanChatName === cleanHeaderName || chatName.includes(headerText) || headerText.includes(chatName)) {
                                const chatId = item.getAttribute('data-chat-id');
                                if (chatId) {
                                    console.log('‚úÖ Chat encontrado por nombre, actualizando currentChatId:', chatId);
                                    currentChatId = chatId;
                                    // Tambi√©n marcar como activo
                                    item.classList.add('active');
                                    return chatId;
                                }
                            }
                        }
                    }
                }
            }
            
            console.warn('‚ö†Ô∏è No se pudo encontrar el chat seleccionado');
            return null;
        }
        
        // FUNCIONALIDAD DE SUBIDA DESHABILITADA
        // Los videos se suben desde la app de Telegram, la web solo los muestra
        /*
        // Funci√≥n para mostrar el modal de subida de video
        function showVideoUploadModal(file) {
            if (!file) {
                alert('No se seleccion√≥ ning√∫n archivo');
                return;
            }
            
            // PRIMERO: Intentar usar currentChatId directamente (m√°s confiable)
            let chatId = currentChatId;
            console.log('üîç [showVideoUploadModal] currentChatId inicial:', chatId);
            
            // Si no hay currentChatId, intentar obtenerlo de m√∫ltiples formas
            if (!chatId) {
                // 1. Buscar elemento activo en DOM
                const activeChatItem = document.querySelector('.chat-item.active');
                if (activeChatItem) {
                    chatId = activeChatItem.getAttribute('data-chat-id');
                    console.log('üîç [showVideoUploadModal] Chat encontrado en elemento activo:', chatId);
                }
                
                // 2. Si a√∫n no hay, verificar si el header est√° visible (significa que hay un chat seleccionado)
                if (!chatId) {
                    const chatHeader = document.getElementById('chatHeader');
                    const isHeaderVisible = chatHeader && chatHeader.style.display !== 'none' && chatHeader.style.display !== '';
                    console.log('üîç [showVideoUploadModal] Header visible:', isHeaderVisible);
                    
                    if (isHeaderVisible) {
                        // Buscar en todos los chats por el nombre del header
                        const headerName = document.getElementById('chatHeaderName')?.textContent.trim();
                        console.log('üîç [showVideoUploadModal] Nombre en header:', headerName);
                        
                        if (headerName) {
                            // Buscar en la lista de chats cargados
                            const foundChat = chats.find(chat => {
                                const cleanChatName = chat.name?.trim();
                                const cleanHeaderName = headerName.replace(/‚úì/g, '').replace(/\s+/g, ' ').trim();
                                return cleanChatName === cleanHeaderName || cleanChatName?.includes(cleanHeaderName) || cleanHeaderName.includes(cleanChatName);
                            });
                            
                            if (foundChat) {
                                chatId = foundChat.id;
                                console.log('üîç [showVideoUploadModal] Chat encontrado por nombre en lista:', chatId);
                            } else {
                                // Buscar en el DOM por nombre
                                const allChatItems = document.querySelectorAll('.chat-item[data-chat-id]');
                                for (let item of allChatItems) {
                                    const chatNameElement = item.querySelector('.chat-name');
                                    if (chatNameElement) {
                                        const chatName = chatNameElement.textContent.trim().replace(/‚úì/g, '').replace(/\s+/g, ' ').trim();
                                        const cleanHeaderName = headerName.replace(/‚úì/g, '').replace(/\s+/g, ' ').trim();
                                        if (chatName === cleanHeaderName || chatName.includes(cleanHeaderName) || cleanHeaderName.includes(chatName)) {
                                            chatId = item.getAttribute('data-chat-id');
                                            console.log('üîç [showVideoUploadModal] Chat encontrado en DOM por nombre:', chatId);
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            console.log('üîç [showVideoUploadModal] Chat ID final:', chatId);
            
            if (!chatId) {
                alert('Selecciona un chat primero. Haz clic en un chat de la lista para seleccionarlo.');
                return;
            }
            
            // ACTUALIZAR currentChatId para futuras referencias
            currentChatId = chatId;
            console.log('‚úÖ [showVideoUploadModal] Chat verificado y actualizado. currentChatId:', currentChatId);
            
            selectedVideoFile = file;
            
            // Mostrar informaci√≥n del archivo
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            document.getElementById('videoUploadInfo').innerHTML = `
                <strong>üìπ ${file.name}</strong><br>
                <small>Tama√±o: ${fileSize} MB</small>
            `;
            
            // Limpiar el campo de descripci√≥n
            document.getElementById('videoDescription').value = '';
            
            // Mostrar el modal
            document.getElementById('videoUploadModal').style.display = 'flex';
        }
        */
        
        // Funci√≥n para cerrar el modal (mantenida por si se necesita)
        function closeVideoUploadModal() {
            document.getElementById('videoUploadModal').style.display = 'none';
            selectedVideoFile = null;
            // Limpiar el input de video
            document.getElementById('videoInput').value = '';
        }
        
        // FUNCIONALIDAD DE SUBIDA DESHABILITADA
        /*
        // Funci√≥n para confirmar y subir el video
        async function confirmVideoUpload() {
            if (!selectedVideoFile) {
                alert('Error: No hay archivo seleccionado');
                return;
            }
            
            // Verificar el chat - usar currentChatId directamente primero
            let chatId = currentChatId;
            
            // Si no hay, intentar obtenerlo de nuevo
            if (!chatId) {
                const activeChatItem = document.querySelector('.chat-item.active');
                if (activeChatItem) {
                    chatId = activeChatItem.getAttribute('data-chat-id');
                    currentChatId = chatId;
                }
            }
            
            if (!chatId) {
                alert('Error: No hay chat seleccionado. Por favor, selecciona un chat primero.');
                closeVideoUploadModal();
                return;
            }
            
            // Asegurar que currentChatId est√© actualizado
            currentChatId = chatId;
            console.log('‚úÖ [confirmVideoUpload] Chat verificado. currentChatId:', currentChatId, 'chatId:', chatId);
            
            // IMPORTANTE: Guardar el archivo y chatId en variables locales ANTES de cerrar el modal
            // porque closeVideoUploadModal() establece selectedVideoFile = null
            const fileToUpload = selectedVideoFile;
            const chatIdToPass = chatId;
            
            // Obtener la descripci√≥n ANTES de cerrar el modal
            const description = document.getElementById('videoDescription').value.trim();
            
            console.log('üîç [confirmVideoUpload] Archivo guardado:', fileToUpload, 'chatId:', chatIdToPass);
            
            // Cerrar el modal (esto establecer√° selectedVideoFile = null, pero ya lo guardamos)
            closeVideoUploadModal();
            
            // Verificar una vez m√°s antes de llamar a uploadVideo
            console.log('üîç [confirmVideoUpload] Antes de llamar uploadVideo. fileToUpload:', fileToUpload, 'chatIdToPass:', chatIdToPass);
            
            // Subir el video - pasar el archivo y chatId expl√≠citamente
            await uploadVideo(fileToUpload, description, chatIdToPass);
        }
        */
        
        // FUNCIONALIDAD DE SUBIDA DESHABILITADA
        /*
        // Funci√≥n para subir video
        async function uploadVideo(file, description = '', chatIdParam = null) {
            console.log('üöÄ [uploadVideo] Iniciando subida. file:', file, 'currentChatId:', currentChatId, 'chatIdParam:', chatIdParam);
            
            // Verificar archivo primero
            if (!file) {
                alert('Error: No hay archivo seleccionado');
                return;
            }
            
            // Usar el chatId pasado como par√°metro, o currentChatId, o intentar obtenerlo
            let chatId = chatIdParam || currentChatId;
            console.log('üîç [uploadVideo] chatId inicial (param o currentChatId):', chatId);
            
            // Si no hay, intentar obtenerlo de m√∫ltiples formas
            if (!chatId) {
                // 1. Buscar elemento activo en DOM
                const activeChatItem = document.querySelector('.chat-item.active');
                if (activeChatItem) {
                    chatId = activeChatItem.getAttribute('data-chat-id');
                    console.log('üîç [uploadVideo] Chat encontrado en elemento activo:', chatId);
                }
                
                // 2. Si a√∫n no hay, verificar header
                if (!chatId) {
                    const chatHeader = document.getElementById('chatHeader');
                    const isHeaderVisible = chatHeader && chatHeader.style.display !== 'none' && chatHeader.style.display !== '';
                    if (isHeaderVisible) {
                        const headerName = document.getElementById('chatHeaderName')?.textContent.trim();
                        if (headerName) {
                            // Buscar en la lista de chats
                            const foundChat = chats.find(chat => {
                                const cleanChatName = chat.name?.trim();
                                const cleanHeaderName = headerName.replace(/‚úì/g, '').replace(/\s+/g, ' ').trim();
                                return cleanChatName === cleanHeaderName || cleanChatName?.includes(cleanHeaderName) || cleanHeaderName.includes(cleanChatName);
                            });
                            if (foundChat) {
                                chatId = foundChat.id;
                                console.log('üîç [uploadVideo] Chat encontrado por nombre en lista:', chatId);
                            }
                        }
                    }
                }
            }
            
            console.log('üîç [uploadVideo] Chat ID final:', chatId);
            
            if (!chatId) {
                alert('Selecciona un chat primero. Haz clic en un chat de la lista para seleccionarlo.');
                return;
            }
            
            // Asegurar que currentChatId est√© actualizado
            currentChatId = chatId;
            console.log('‚úÖ [uploadVideo] Chat verificado. Subiendo video a chat:', currentChatId);
            
            // Mostrar progreso inmediatamente
            showUploadProgress();
            updateUploadProgress(0, 'uploading');
            
            // Asegurar que tenemos el chat_id correcto
            const chatIdToUse = currentChatId || chatId;
            console.log('üì§ [uploadVideo] Usando chat_id:', chatIdToUse, 'currentChatId:', currentChatId, 'chatId param:', chatId);
            
            if (!chatIdToUse) {
                alert('Error: No se pudo determinar el chat. Por favor, selecciona un chat primero.');
                closeUploadProgress();
                return;
            }
            
            const formData = new FormData();
            formData.append('video', file);
            formData.append('chat_id', chatIdToUse);
            if (description) {
                formData.append('description', description);
            }
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (response.ok) {
                    // Iniciar monitoreo de progreso si hay upload_id
                    if (data.upload_id) {
                        // Iniciar monitoreo inmediatamente
                        monitorUploadProgress(data.upload_id);
                        // El monitoreo se encargar√° de recargar los mensajes cuando termine
                    } else {
                        // Si no hay upload_id, marcar como completado y recargar
                        updateUploadProgress(100, 'completed');
                        setTimeout(async () => {
                            await loadMessages(currentChatId);
                        }, 2000);
                    }
                } else {
                    closeUploadProgress();
                    alert('Error: ' + (data.error || 'Error al subir video'));
                }
            } catch (error) {
                closeUploadProgress();
                alert('Error: ' + error.message);
            }
        }
        */
        
        // Subida de videos deshabilitada - Los videos se suben desde la app de Telegram
        // La aplicaci√≥n web solo muestra y reproduce videos que ya est√°n en Telegram
        /*
        document.getElementById('videoInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                showVideoUploadModal(file);
            }
        });
        
        document.getElementById('uploadVideoBtn').addEventListener('click', () => {
            document.getElementById('videoInput').click();
        });
        */
        
        // Enviar mensaje
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !currentChatId) return;
            
            try {
                const response = await fetch('/api/send_message', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: currentChatId,
                        text: text
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    // Recargar mensajes para ver el nuevo mensaje
                    await loadMessages(currentChatId);
                    input.value = '';
                } else {
                    alert('Error: ' + (data.error || 'Error al enviar mensaje'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Funci√≥n para cerrar sesi√≥n
        async function logout() {
            if (!confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                // Verificar que la respuesta es JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (response.ok && data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        window.location.href = '/';
                    }
                } else {
                    // Si no es JSON, redirigir de todas formas
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error:', error);
                // Redirigir de todas formas
                window.location.href = '/';
            }
        }
        
        // Verificar conexi√≥n y cargar chats
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                if (!data.connected) {
                    window.location.href = '/';
                    return;
                }
                // Si est√° conectado, cargar chats
                console.log('‚úÖ Conectado, cargando chats...');
                await loadChats();
            } catch (error) {
                console.error('Error verificando conexi√≥n:', error);
                window.location.href = '/';
            }
        });
    </script>
    <!-- Video.js JS -->
    <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
</body>
</html>

